# Sample workflow for building and deploying a Hugo site to GitHub Pages
name: Deploy Hugo site to Pages

on:
  # 当你向 main 分支推送代码时，触发此工作流
  push:
    branches: ["main"]

  # 允许你从 GitHub 网站的手动点击运行此工作流
  workflow_dispatch:

# 设置 GITHUB_TOKEN 的权限，以允许部署到 GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# 同一时间只允许一个部署进行，避免冲突
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # 1. 构建网站的任务
  build:
    runs-on: ubuntu-latest # 在最新的 Ubuntu 系统环境中运行
    steps:
      # 检出（下载）你的代码到虚拟机
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive # 重要：同时拉取你的主题子模块
          fetch-depth: 0

      # 安装指定版本的 Hugo
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.147.8' # 你可以指定一个与本地一致的版本，或直接写 'latest'（最新版）
          extended: true # 使用扩展版，兼容更多主题

      # 运行 Hugo 命令构建静态网站
      - name: Build
        run: hugo --minify # --minify 会压缩代码，让网站加载更快

      # 将构建好的网页文件（在 public/ 目录下）打包为一个“工件”
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public # 上传 Hugo 生成的 public 文件夹

  # 2. 部署网站的任务（此任务会在构建任务成功后自动运行）
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }} # 部署成功后的访问地址
    runs-on: ubuntu-latest
    needs: build # 依赖于 build 任务
    steps:
      # 将打包好的网页文件部署到 GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4